steps:

# Install Terraform
- task: TerraformInstaller@0
  displayName: 'Terraform Install'
  inputs:
    terraformVersion: '$(terraformVersion)'

# Initialise Terraform
- task: TerraformCLI@0
  displayName: 'Terraform Initialise'
  inputs:
    command: 'init'
    workingDirectory: '$(System.DefaultWorkingDirectory)/$(Service)/'
    backendType: 'azurerm'
    backendServiceArm: '$(backendServiceArm)'
    ensureBackend: true
    backendAzureRmResourceGroupName: '$(backendAzureRmResourceGroupName)'
    backendAzureRmResourceGroupLocation: '$(backendAzureRmResourceGroupLocation)'
    backendAzureRmStorageAccountName: '$(backendAzureRmStorageAccountName)'
    backendAzureRmContainerName: '$(backendAzureRmContainerName)'
    backendAzureRmKey: '$(backendAzureRmKey)'

# Create workspace (if does not exist)
- task: TerraformCLI@0
  continueOnError: true
  displayName: 'Terraform Workspace new'
  inputs:
    workingDirectory: '$(System.DefaultWorkingDirectory)/$(Service)/'
    command: 'workspace'
    workspaceSubCommand: 'new'
    workspaceName: $(Environment)

# Select workspace (if exists)
- task: TerraformCLI@0
  #condition: Failed()
  displayName: 'Terraform Workspace select'
  inputs:
    workingDirectory: '$(System.DefaultWorkingDirectory)/$(Service)/'
    command: 'workspace'
    workspaceSubCommand: 'select'
    workspaceName: $(Environment)